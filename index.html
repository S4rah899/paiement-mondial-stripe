<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Paiement Stripe + Mondial Relay</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://widget.mondialrelay.com/parcelshop-picker/jquery.plugin.mondialrelay.parcelshoppicker.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=TA_CLE_PUBLIQUE_GOOGLE"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ton CSS existant */
  </style>
</head>
<body>
<div class="form-container">
  <h2>R√âGLER MA COMMANDE</h2>
  <form id="checkoutForm" onsubmit="return verifierPointRelais()">
    <label>PSEUDO TIKTOK :</label>
    <input type="text" id="pseudoTikTok" required />
    <label>NOM & PR√âNOM :</label>
    <input type="text" id="nomPrenom" required />
    <label>ADRESSE :</label>
    <textarea id="adresseComplete" rows="2" required></textarea>
    <label>T√âL√âPHONE :</label>
    <input type="tel" id="telephone" required />
    <label>NUM√âRO DE COMMANDE :</label>
    <input type="text" id="numeroCommande" required />
    <label>MONTANT DU PRODUIT (‚Ç¨) :</label>
    <input type="number" id="montantProduit" oninput="calculerTotal()" min="0" step="0.01" required />
    <label>FRAIS DE PORT (‚Ç¨) :</label>
    <input type="text" value="5.00" id="fraisPort" readonly />
    <label>MONTANT TOTAL (‚Ç¨) :</label>
    <input type="text" id="montantTotal" readonly />
    <label>POINT RELAIS :</label>
    <input type="hidden" id="Retour_Widget" name="point_relais_id" />
    <div id="Zone_Widget"></div>
    <div id="selectedPointRelais">üìç Aucun point relais s√©lectionn√©</div>
    <label>CARTE BANCAIRE :</label>
    <div id="card-element"></div>
    <div id="card-errors"></div>
    <button type="submit">PAYER MAINTENANT</button>
  </form>
</div>

<script>
const stripe = Stripe("pk_live_51RWHfeE4cEWOVVQdBZjduOiwl7nee5Dj0lweLqrRX5MyrHCuUBXteL6yko2FdyKg4v8MT8EStzerBtPtXPmA5TGp00AQLTHeMB");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");
card.on("change", e => document.getElementById("card-errors").textContent = e.error?.message || "");

function calculerTotal() {
  const prod = parseFloat(document.getElementById("montantProduit").value) || 0;
  document.getElementById("montantTotal").value = (prod + 5).toFixed(2);
}
calculerTotal();

function verifierPointRelais() {
  if (!document.getElementById("Retour_Widget").value) {
    alert("S√©lectionnez un point relais.");
    return false;
  }
  return true;
}

$(document).ready(function(){
  $("#Zone_Widget").MR_ParcelShopPicker({
    Target: "#Retour_Widget",
    Brand: "CC23JWR4",
    Country: "FR",
    Responsive: true,
    ShowResultsOnMap: false,
    EnableGmap: false,
    OnParcelShopSelected: pt => {
      $("#selectedPointRelais").text(`üì¶ ${pt.ID} ¬∑ ${pt.Nom}, ${pt.CP} ${pt.Ville}`);
    }
  });
});

document.getElementById("checkoutForm").addEventListener("submit", async e => {
  e.preventDefault();
  if (!verifierPointRelais()) return;
  const pseudoTikTok = $("#pseudoTikTok").val().trim();
  const nomPrenom = $("#nomPrenom").val().trim();
  const adresseComplete = $("#adresseComplete").val().trim();
  const telephone = $("#telephone").val().trim();
  const numeroCommande = $("#numeroCommande").val().trim();
  const montantTotal = $("#montantTotal").val().trim();
  const pointRelaisId = $("#Retour_Widget").val();

  const { paymentMethod, error } = await stripe.createPaymentMethod({
    type: "card",
    card: card,
    billing_details: { name: nomPrenom }
  });

  if (error) { alert(error.message); return; }

  try {
    const res = await fetch("/api/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        pseudoTikTok, nomPrenom, adresseComplete,
        telephone, numeroCommande, montantTotal, pointRelaisId,
        payment_method_id: paymentMethod.id
      })
    });
    const data = await res.json();

    if (data.requires_action) {
      const result = await stripe.confirmCardPayment(data.payment_intent_client_secret);
      if (result.error) alert("Erreur : " + result.error.message);
      else if (result.paymentIntent.status === "succeeded") alert("‚úÖ Paiement r√©ussi !");
    } else if (data.success) alert("‚úÖ Paiement r√©ussi !");
    else alert("Erreur paiement : " + (data.message || "inconnue"));
  } catch (err) { console.error(err); alert("Erreur serveur ou r√©seau."); }
});
</script>
</body>
</html>
