<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Paiement Stripe + Mondial Relay</title>

  <!-- jQuery compatible widget -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

  <!-- Google Maps API (si besoin de GMap, sinon Leaflet) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMXWLnKzoDAl0jSkqLFGNIXwEDY8skm7Y"></script>

  <!-- Widget MR V3 -->
  <script src="https://widget.mondialrelay.com/parcelshop-picker/jquery.plugin.mondialrelay.parcelshoppicker.min.js"></script>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f9f9f9;
      padding: 20px; margin: 0;
    }
    .form-container {
      max-width: 600px; margin: auto;
      background: white; padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    h2 {
      text-align: center; font-size: 20px;
      margin-bottom: 20px; color: #333;
    }
    input, textarea {
      width: 100%; padding: 12px;
      margin-bottom: 16px; border: 1px solid #ccc;
      border-radius: 8px; font-size: 15px;
    }
    label {
      font-weight: 600; font-size: 14px;
      display: block; margin-bottom: 6px;
    }
    button {
      width: 100%; padding: 14px; border: none;
      border-radius: 8px; font-size: 16px;
      font-weight: 600; cursor: pointer;
      background-color: #111; color: white;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #333;
    }

    #Zone_Widget {
      width: 100%; min-height: 350px;
      overflow: hidden; border: 1px solid #ddd;
      margin-bottom: 20px; border-radius: 8px;
      background: #fff; padding: 10px;
      position: relative;
    }

    #Zone_Widget iframe,
    #Zone_Widget .mrMap,
    #Zone_Widget > div {
      width: 100% !important;
      max-width: 100% !important;
    }

    #selectedPointRelais {
      font-weight: bold; color: #0070f3;
      margin: 10px 0; min-height: 24px;
      text-align: center;
    }

    #card-element {
      border: 1px solid #ccc; border-radius: 8px;
      padding: 12px; margin-bottom: 16px;
    }

    #card-errors {
      color: red; margin-bottom: 16px;
    }
  </style>
</head>
<body>

<div class="form-container">
  <h2>R√âGLER MA COMMANDE</h2>

  <form id="checkoutForm">
    <label for="pseudoTikTok">PSEUDO TIKTOK :</label>
    <input type="text" id="pseudoTikTok" required />

    <label for="nomPrenom">NOM & PR√âNOM :</label>
    <input type="text" id="nomPrenom" required />

    <label for="adresseComplete">ADRESSE COMPL√àTE :</label>
    <textarea id="adresseComplete" rows="2" required></textarea>

    <label for="telephone">T√âL√âPHONE :</label>
    <input type="tel" id="telephone" required />

    <label for="numeroCommande">NUM√âRO DE COMMANDE :</label>
    <input type="text" id="numeroCommande" required />
    
    <label for="email">ADRESSE MAIL :</label>
    <input type="email" id="email" required />

    <label for="montantProduit">MONTANT DU PRODUIT (‚Ç¨) :</label>
    <input type="number" id="montantProduit" required oninput="calculerTotal()" min="0" step="0.01" />

    <label for="fraisPort">FRAIS DE PORT (‚Ç¨) :</label>
    <input type="text" value="5.00" id="fraisPort" readonly style="background:#f9f9f9;color:#888;" />

    <label for="montantTotal">MONTANT TOTAL (‚Ç¨) :</label>
    <input type="text" id="montantTotal" readonly style="background:#f9f9f9;color:#888;" />

    <label>CHOISISSEZ UN POINT RELAIS :</label>
    <input type="hidden" id="Retour_Widget" name="point_relais_id" />
    <div id="Zone_Widget"></div>
    <div id="selectedPointRelais">üìç Aucun point relais s√©lectionn√©</div>

    <label for="card-element">CARTE BANCAIRE :</label>
    <div id="card-element"></div>
    <div id="card-errors"></div>

    <button type="submit" id="payerBtn">PAYER MAINTENANT</button>
  </form>
</div>

<script>
  // Stripe initialisation (remplace pk_live_... par ta cl√© publique Stripe)
  const stripe = Stripe("pk_live_51RWHfeE4cEWOVVQdBZjduOiwl7nee5Dj0lweLqrRX5MyrHCuUBXteL6yko2FdyKg4v8MT8EStzerBtPtXPmA5TGp00AQLTHeMB");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");
  card.on("change", e => {
    document.getElementById("card-errors").textContent = e.error ? e.error.message : "";
  });

  // Calcul du total produit + frais port
  function calculerTotal() {
    const prod = parseFloat(document.getElementById("montantProduit").value) || 0;
    const frais = parseFloat(document.getElementById("fraisPort").value) || 0;
    document.getElementById("montantTotal").value = (prod + frais).toFixed(2);
  }

  // V√©rifie si point relais s√©lectionn√©
  function verifierPointRelais() {
    if (!document.getElementById("Retour_Widget").value) {
      alert("S√©lectionnez un point relais.");
      return false;
    }
    return true;
  }

  // Init widget Mondial Relay
  $(document).ready(function(){
    $("#Zone_Widget").MR_ParcelShopPicker({
      Target: "#Retour_Widget",
      Brand: "CC23JWR4",
      Country: "FR",
      Responsive: true,
      ShowResultsOnMap: false,
      EnableGmap: false,
      OnParcelShopSelected: function(pt) {
        $("#selectedPointRelais").text(`üì¶ ${pt.ID} ¬∑ ${pt.Nom}, ${pt.CP} ${pt.Ville}`);
      }
    });
    setTimeout(() => {
      $("#Zone_Widget").css({ overflowX:'hidden', maxWidth:'100%' });
    }, 500);
  });

  // Form submit
  document.getElementById("checkoutForm").addEventListener("submit", async e => {
    e.preventDefault();
    if (!verifierPointRelais()) return;

    calculerTotal();

    const pseudoTikTok = document.getElementById("pseudoTikTok").value.trim();
    const nomPrenom = document.getElementById("nomPrenom").value.trim();
    const adresseComplete = document.getElementById("adresseComplete").value.trim();
    const telephone = document.getElementById("telephone").value.trim();
    const numeroCommande = document.getElementById("numeroCommande").value.trim();
    const montantTotal = document.getElementById("montantTotal").value.trim();
    const pointRelaisId = document.getElementById("Retour_Widget").value.trim();

    // Cr√©e PaymentMethod Stripe
    const { paymentMethod, error } = await stripe.createPaymentMethod("card", card);
    if (error) {
      document.getElementById("card-errors").textContent = error.message;
      return;
    }

    // Pr√©pare donn√©es √† envoyer
    const dataToSend = {
      pseudoTikTok,
      nomPrenom,
      adresseComplete,
      telephone,
      numeroCommande,
      montantTotal,
      pointRelaisId,
      payment_method_id: paymentMethod.id
    };

    // Envoie au backend
    fetch("/api/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dataToSend)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Paiement r√©ussi ! Merci pour votre commande.");
        // Optionnel : redirection vers page confirmation
        // window.location.href = "/confirmation";
      } else {
        alert("Erreur : " + (data.message || "Paiement √©chou√©."));
      }
    })
    .catch(() => alert("Erreur r√©seau, r√©essayez plus tard."));
  });
</script>

</body>
</html>
