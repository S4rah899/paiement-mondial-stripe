<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paiement - Stripe + Mondial Relay</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#f7f7f7}
    .container{max-width:720px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    label{display:block;margin-bottom:12px}
    input{display:block;padding:8px;width:100%;box-sizing:border-box}
    #card-element{margin:16px 0;padding:12px;border:1px solid #ddd;border-radius:6px}
    button{background:#111;color:#fff;padding:10px 14px;border:0;border-radius:6px;cursor:pointer}
    .muted{color:#666;font-size:0.9rem}
    .hidden{display:none}
    #points-popup{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
    .popup-inner{background:#fff;padding:16px;border-radius:8px;max-width:640px;width:90%}
    #points-list{list-style:none;padding:0;max-height:360px;overflow:auto}
    #points-list li{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
    #message{margin-top:12px}
  </style>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <main class="container">
    <h1>Paiement ‚Äî Stripe + Mondial Relay</h1>

    <form id="checkout-form">
      <label>Nom complet
        <input id="name" name="name" required>
      </label>

      <label>T√©l√©phone
        <input id="phone" name="phone">
      </label>

      <label>Code postal
        <input id="postalCode" name="postalCode" required>
      </label>

      <div style="margin-bottom:12px">
        <button type="button" id="open-points">Choisir point relais</button>
        <div id="selected-point" class="muted">Aucun point relais s√©lectionn√©</div>
      </div>

      <label>Montant (en cents)
        <input id="amount" name="amount" value="1000" required>
      </label>

      <div id="card-element"></div>

      <button id="pay" type="submit">PAYER MAINTENANT</button>

      <div id="message" role="status"></div>
    </form>

    <!-- Popup simple pour les points relais -->
    <div id="points-popup" class="hidden" aria-hidden="true">
      <div class="popup-inner">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Points relais proches</h2>
          <button id="close-points" style="background:#ccc;color:#000;padding:6px 10px;border-radius:6px">Fermer</button>
        </div>
        <ul id="points-list"></ul>
      </div>
    </div>
  </main>

  <script>
  (function(){
    // Use publishable key from env injected by Vercel if available, else fallback (not ideal for prod but works)
    const PUBLISHABLE_KEY = window.ENV && window.ENV.STRIPE_PUBLISHABLE ? window.ENV.STRIPE_PUBLISHABLE : (typeof STRIPE_PUBLISHABLE !== 'undefined' ? STRIPE_PUBLISHABLE : 'pk_live_51RWHfeE4cEWOVVQdBZjduOiwl7nee5Dj0lweLqrRX5MyrHCuUBXteL6yko2FdyKg4v8MT8EStzerBtPtXPmA5TGp00AQLTHeMB');

    const stripe = Stripe(PUBLISHABLE_KEY);
    const elements = stripe.elements();
    const card = elements.create('card', { hidePostalCode: true });
    card.mount('#card-element');

    const form = document.getElementById('checkout-form');
    const amountInput = document.getElementById('amount');
    const messageDiv = document.getElementById('message');

    // Points relais popup controls
    const openPointsBtn = document.getElementById('open-points');
    const pointsPopup = document.getElementById('points-popup');
    const closePointsBtn = document.getElementById('close-points');
    const pointsList = document.getElementById('points-list');
    const selectedPointDiv = document.getElementById('selected-point');

    openPointsBtn.addEventListener('click', async () => {
      const postalCode = document.getElementById('postalCode').value.trim();
      if (!postalCode) return alert('Saisis le code postal');

      pointsPopup.classList.remove('hidden');
      pointsPopup.setAttribute('aria-hidden', 'false');
      pointsList.innerHTML = '<li>Chargement...</li>';

      try {
        const res = await fetch(`/mondialrelay?postalCode=${encodeURIComponent(postalCode)}`);
        const data = await res.json();

        // Normalisation: si data.points pr√©sent, use it; else try common SOAP parsed structure; else show raw
        let points = [];
        if (Array.isArray(data.points)) {
          points = data.points;
        } else if (data.raw && data.raw.WSI3_PointRelais_Recherche && data.raw.WSI3_PointRelais_Recherche.PointRelais) {
          // structure possible: PointRelais peut √™tre tableau ou objet
          const pr = data.raw.WSI3_PointRelais_Recherche.PointRelais;
          points = Array.isArray(pr) ? pr : [pr];
        } else if (data.raw && data.raw.Points) {
          // fallback
          const pr = data.raw.Points;
          points = Array.isArray(pr) ? pr : (pr ? [pr] : []);
        }

        pointsList.innerHTML = '';
        if (!points.length) {
          const li = document.createElement('li');
          li.textContent = 'Aucun point format√© (voir console pour la r√©ponse brute)';
          pointsList.appendChild(li);
          console.log('R√©ponse MR brute :', data);
          return;
        }

        points.forEach((p) => {
          const name = p.Nom || p.name || p.Libelle || p.Local;
          const addr = (p.Adresse1 || p.address || p.Adresse || '') + (p.Ville ? ' ‚Äî ' + p.Ville : '') + (p.CodePostal ? ' ' + p.CodePostal : '');
          const li = document.createElement('li');
          li.textContent = (name ? name + ' ‚Äî ' : '') + (addr || JSON.stringify(p).slice(0,80));
          li.addEventListener('click', () => {
            // Save selection in a hidden friendly format (you can change)
            selectedPointDiv.textContent = name ? (name + ' ‚Äî ' + addr) : JSON.stringify(p);
            selectedPointDiv.dataset.point = JSON.stringify(p);
            pointsPopup.classList.add('hidden');
            pointsPopup.setAttribute('aria-hidden', 'true');
          });
          pointsList.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        pointsList.innerHTML = '<li>Erreur lors de la r√©cup√©ration des points relais</li>';
      }
    });

    closePointsBtn.addEventListener('click', () => {
      pointsPopup.classList.add('hidden');
      pointsPopup.setAttribute('aria-hidden', 'true');
    });

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      messageDiv.textContent = 'Cr√©ation du paiement...';

      const amount = Number(amountInput.value);
      if (!amount || isNaN(amount) || amount <= 0) { messageDiv.textContent = 'Montant invalide'; return; }

      // Create PaymentIntent on server
      const resp = await fetch('/create-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount,
          currency: 'eur',
          metadata: {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            postalCode: document.getElementById('postalCode').value,
            pointRelais: selectedPointDiv.dataset.point || ''
          }
        })
      });

      const json = await resp.json();
      if (json.error) { messageDiv.textContent = 'Erreur serveur: ' + json.error; return; }
      const clientSecret = json.clientSecret;
      if (!clientSecret) { messageDiv.textContent = 'Pas de clientSecret re√ßu'; console.error(json); return; }

      messageDiv.textContent = 'Confirmation...';
      const { error: stripeError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card,
          billing_details: {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value
          }
        }
      });

      if (stripeError) {
        messageDiv.textContent = stripeError.message;
        return;
      }

      if (paymentIntent && paymentIntent.status === 'succeeded') {
        messageDiv.textContent = 'Paiement r√©ussi üéâ ‚Äî ID: ' + paymentIntent.id;
        // TODO: rediriger ou enregistrer commande c√¥t√© serveur
      } else {
        messageDiv.textContent = 'Paiement : ' + (paymentIntent ? paymentIntent.status : 'statut inconnu');
      }
    });
  })();
  </script>
</body>
</html>
